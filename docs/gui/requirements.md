# Switch Automation Macro GUI 要件定義書

## 1. はじめに
本ドキュメントは、Nintendo Switch向け自動化マクロ（以下「マクロ」）の管理・実行を行うGUIアプリケーションの要件定義をまとめたものです。  
既存の `niart120/Project_NyX` リポジトリにおける `macros/` フォルダ配置や `MacroExecutor` 関連コードと乖離せず、GUIレイヤでの利用フローを具体化します。

---

## 2. 起動・初期化フロー
- アプリ起動時に以下のフォルダを確認  
  - `macros/`（マクロスクリプト配置）  
  - `snapshots/`（スナップショット保存用）  
  - `static/`（今後のGUIリソース用）  
- 存在しない場合は、内部で `nyxpy init` 相当の処理を自動実行し、必要フォルダを作成  

---

## 3. 全体概要
- アプリ名称（仮）：Switch Automation Macro GUI  
- 開発言語：Python (PySide6)  
- エントリポイント：`run_gui` スクリプト  
- 主な機能  
  1. マクロ一覧画面  
  2. マクロ実行フロー（ステータス・ログ・プレビュー・スナップショット）  
  3. 実行設定画面  

**設計要点**:
- Manager系（SerialManager, CaptureManager, SettingsService）は`singletons.py`で一元管理され、DeviceModel経由でGUI各所に注入される。
- デバイス切替や状態変更はEventBusで伝播し、各Pane/Widgetは疎結合に保たれる。
- PreviewPaneやVirtualControllerPane等は、アクティブなデバイスを外部から受け取り、それを主軸に操作する。

---

## 4. マクロ一覧画面

### 4.1 表示項目
- マクロ名（Python クラス名）  
- 説明文（`MacroBase.description` プロパティから取得）  
- **タグ/カテゴリ**  
  - 現状の `MacroBase` 実装にはタグ情報がないため、GUI要件に合わせて `MacroBase.tags: list[str]` を追加する改修を行う  

### 4.2 機能要件
- インクリメンタルサーチ  
  - マクロ名・タグを対象に部分一致検索  
  - 入力に応じて結果を即時更新（100ms以内目標）  
- タグ／カテゴリ絞り込み  
  - 複数チェックボックスで AND 条件絞込  
- 選択前状態  
  - リストボックスで選択後、実行ボタンが有効化  
  - 設定画面ボタンもアクセス可  

---

## 5. マクロ実行フロー

### 5.1 状態遷移
1. **選択前**  
2. **実行中**  
   - ステータスバーのインジケータがアクティブ  
   - 実行ボタン・設定UIを無効化  
   - キャンセルボタンを有効化  
3. **完了／中断**  
   - インジケータに完了 or 中断状態を表示  
   - 実行ボタン・設定UIを再度有効化  

### 5.2 キャンセル動作
- 安全に終了処理（`MacroStopException` をトリガー）実行後に停止  
- 中断時はインジケータで「中断」と表示  

### 5.3 例外ハンドリング
- `MacroStopException` 以外の未処理例外  
  - モーダルダイアログでエラーメッセージ表示  
  - 「再試行／終了」ボタン付き  
  - ステータスバーに「エラー終了」を表示  

---

## 6. 実行ステータス／ログ表示

### 6.1 表示項目
- マクロ進行状況（ステータスバー）  
- リアルタイムログ（テキストストリーム方式）  
- プレビュー映像  

### 6.2 ログ機能要件
- ログレベル：Info／Warning／Error  
- レベル別フィルタ（チェックボックス並列表示）  
- 自動永続化：`log_manager.py` 側で担保  
- GUI でのログエクスポート不要  
- 更新方式：`log_manager` シングルトンインスタンスからの直接参照  

---

## 7. プレビュー＆スナップショット

### 7.1 プレビュー映像
- キャプチャデバイス検出：OpenCV を利用  
- キャプチャデバイスをプルダウンで選択  
- 同時出力は非対応  
- FPS は設定画面から指定  
- **デバイス切替はDeviceModel経由で行い、状態変更はEventBusで伝播する**

### 7.2 スナップショット
- トリガー：「スナップショット」ボタン押下  
- 形式：PNG  
- 保存先：起動時自動生成の `snapshots/` フォルダ  
- ファイル名：`{YYYYMMDD_HHMMSS}.png`  
- フィードバック：ステータスバーに完了メッセージ  

---

## 8. 実行設定画面

### 8.1 パラメータ設定
- `key=value` 形式で自由に追加・編集  
- 初期値：`load_macro_settings` で取得  
- 保存後は「次回実行時に反映」  

### 8.2 デバイス設定
- キャプチャデバイス：プルダウン形式（OpenCV）  
- シリアルデバイス：プルダウン形式（PySerial）  
- ボーレート／FPS 等は個別入力  
- **設定変更時はDeviceModelのchange_xxx_device()を呼び、状態変更はEventBusで伝播する**

### 8.3 設定保存
- ユーザー設定を永続化  
- プリセット管理不要  

---

## 9. 非機能要件

- クロスプラットフォーム対応（Windows/macOS/Linux）  
- UI はメインスレッド非ブロッキング  
- マクロ実行／キャプチャ取得はバックグラウンドスレッド  
- フレームワーク：PySide6 推奨  
- GUIテスト：pytest-qt or Playwright 等で自動テスト整備  
- ドキュメント：README + 専用ユーザーガイド（docs/ 以下）  
- ログローテーション等は `log_manager.py` 側で担保  
- 多言語対応：日本語優先、英語は将来検討  

---

## 10. パフォーマンス／スケーラビリティ

- 想定マクロ数：〜100本程度  
- 大量リスト用の仮想化／ページング不要  
- インクリメンタル検索応答：100ms以内（仮）  

---

## 11. 配布・CI・運用

- パッケージ化  
  - 社内配布用 wheel/exe を優先  
  - 将来 PyPI への公開も検討  
- CI/CD（GitHub Actions）  
  - ビルド・テスト・リリース自動化（将来的に導入）  
- 初期化コマンド：`nyxpy init` 連携  

---

## 追加: アーキテクチャ設計要点

- Manager系（SerialManager, CaptureManager, SettingsService）は`singletons.py`で一元管理
- DeviceModelがアクティブデバイスの切替・参照・イベント発行を担当
- GUIコンポーネントやコマンドはDeviceModel/Managerからデバイスを受け取り、直接操作
- 状態変更はEventBusで伝播し、疎結合な設計を実現