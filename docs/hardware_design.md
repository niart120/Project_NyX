# ハードウェア連携設計詳細

このドキュメントでは、Nintendo Switch との物理的連携部分、特にキャプチャボードおよびシリアル通信に関する設計方針と実装概要を記載します。(generated by chatGPT o3-mini)

## 1. キャプチャボード連携

### CaptureDevice クラス
- **目的:**  
  - PC に接続されたキャプチャボードから映像フレームを取得する
- **主なメソッド:**
  - `initialize()`: デバイスのオープンとパラメータ設定
  - `get_frame()`: 映像フレームの取得（OpenCV などを利用）
  - `release()`: リソースの解放

### CaptureManager クラス
- **目的:**  
  - 複数のキャプチャデバイスを管理し、利用するデバイスを動的に切り替え可能にする
- **主な機能:**
  - 複数デバイスの登録
  - 利用するデバイスのアクティブ化
  - アクティブデバイスからのフレーム取得とリソース解放

## 2. シリアル通信連携

### SerialComm インターフェースと実装
- **SerialCommInterface:**  
  - シリアル通信に必要な基本操作（open, send, receive, close）を定義
- **SerialComm:**  
  - pyserial を利用した実装例
  - 接続状態の管理、通信エラーやタイムアウトへの対処（現状は簡易実装）

### SerialManager クラス
- **目的:**  
  - 複数のシリアル通信デバイスを管理し、動的に切り替えられる仕組みを提供
- **主な機能:**
  - 複数デバイスの登録と管理
  - 指定されたデバイスのアクティブ化（ポート、ボーレートの指定）
  - フレームワーク側からの send() 呼び出しに対応

## 3. 通信プロトコル

### SerialProtocol クラス
- **目的:**  
  - 高レベル操作（press, release, keyboard など）を、通信プロトコルに基づいたコマンドデータに変換する
- **主なメソッド:**
  - `build_press_command(keys)`: キー押下コマンドの生成
  - `build_release_command(keys)`: キー解放コマンドの生成
  - `build_keyboard_command(text)`: 文字列入力コマンドの生成
- **設計ポイント:**
  - ヘッダー、フッター、チェックサムの計算など、プロトコル仕様に沿ったデータフォーマットを実装  
  - DefaultCommand から呼び出され、疎結合な設計を実現

## 4. デバイス切り替えの仕組み

- **CaptureManager と SerialManager** により、PC に接続された複数デバイスの中から利用するデバイスを動的に切り替え可能  
- 利用するデバイスの初期化、切替、リソース解放を集中管理することで、ハードウェア依存部分を一元化

## 5. 連携と責務の分離

- **フレームワーク側 (DefaultCommand 等):**  
  - 入力操作のタイミング管理、コマンドデータの発行、待機制御の責務を持つ
- **ハードウェア側 (SerialComm, CaptureDevice, SerialProtocol):**  
  - 実際のデバイスとの通信、データ変換、デバイス管理の責務を分担
- **依存性注入:**  
  - SerialProtocol や SerialManager は、テストや将来の拡張に備え、外部から注入可能な設計

