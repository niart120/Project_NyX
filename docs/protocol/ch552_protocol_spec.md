# CH552 Serial Protocol 仕様書

本仕様書は、CH552 デバイス向けのシリアル通信プロトコル（CH552SerialProtocol）について記述します。  
このプロトコルは、Nintendo Switch の自動化支援のために、各種キー操作やスティック入力、キーボード入力を  
バイナリデータに変換して送信するためのものです。

---

## 1. プロトコルフレーム構造

CH552SerialProtocol のデータフレームは、全体で **11バイト** で構成され、各フィールドは以下の通りです。

| バイト番号 | フィールド名    | 説明                                                           | 初期値/デフォルト         |
|------------|----------------|----------------------------------------------------------------|---------------------------|
| 0          | header         | 固定値。プロトコル開始を示す。                                 | `0xAB`                   |
| 1          | btn1           | ボタン操作の下位8ビット。各 Button 値の下位バイトの OR 演算結果。 | `0x00`                   |
| 2          | btn2           | ボタン操作の上位8ビット。各 Button 値の上位バイトの OR 演算結果。 | `0x00`                   |
| 3          | hat            | 方向パッドの状態。押下時は該当する値、解放時は `Hat.CENTER`。   | `Hat.CENTER` (例: 0x08)   |
| 4          | lx             | 左スティックの X 座標。中央位置は `0x80`。                     | `0x80`                   |
| 5          | ly             | 左スティックの Y 座標。中央位置は `0x80`。                     | `0x80`                   |
| 6          | rx             | 右スティックの X 座標。中央位置は `0x80`。                     | `0x80`                   |
| 7          | ry             | 右スティックの Y 座標。中央位置は `0x80`。                     | `0x80`                   |
| 8          | kbdheader      | キーボード入力用のヘッダー。現状は未使用。                      | `0x00`                   |
| 9          | key1           | キーボード入力用のキー情報（1バイト目）。                     | `0x00`                   |
| 10         | key2           | キーボード入力用のキー情報（2バイト目）。                     | `0x00`                   |

---

## 2. 操作ごとの動作

### 2.1 ボタン操作 (Button)

- **押下 (hold):**  
  - 渡された Button 型の値について、  
    - 下位バイト：`btn1` に対して OR 演算で設定  
    - 上位バイト：`btn2` に対して OR 演算で設定  
- **解放 (release):**  
  - 渡された Button 型の値について、  
    - 下位バイト：`btn1` から対応するビットをクリア  
    - 上位バイト：`btn2` から対応するビットをクリア  

### 2.2 方向パッド操作 (Hat)

- **押下:**  
  - 渡された Hat の値で `hat` フィールドを上書きする。
- **解放:**  
  - 解放時は `hat` フィールドを `Hat.CENTER` にリセットする。

### 2.3 スティック操作 (LStick, RStick)

- **押下:**  
  - 各スティックについて、対応する `lx, ly`（または `rx, ry`）フィールドに、  
    - スティックオブジェクトの `x` と `y` 座標を設定する。
- **解放:**  
  - 解放時は、スティックのフィールドをそれぞれ中央値 `0x80` にリセットする。

### 2.4 キーボード入力

- **build_keyboard_command:**  
  - テキスト入力の場合、  
    - `kbdheader` フィールドに開始フラグ（例：`0x01`）を設定し、  
    - `key1`, `key2` にテキストの先頭2文字の ASCII コード（または適宜変換した値）を設定する。

---

## 3. コマンド生成の例

### 3.1 press コマンド例
- **操作:** Button A と Button B の同時押下、Hat を UP に、左スティックを (x=100, y=150) に設定  
- **生成されるフレーム:**  
`[0xAB, btn1, btn2, UP, 100, 150, 0x80, 0x80, 0x00, 0x00, 0x00]` 
※btn1, btn2 は、Button A, B の値に応じた OR 演算結果

### 3.2 release コマンド例
- **操作:** Button A の解放、左スティックを中央にリセット  
- **生成されるフレーム:**  
`[0xAB, (btn1からAがクリアされた値), (btn2からAがクリアされた値), CENTER, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00]`

---

## 4. 注意点

- **内部状態:**  
CH552SerialProtocol は内部状態（key_state）を持ち、連続した操作で状態が変化します。  
release 操作でキーが指定されない場合は、全体が初期状態にリセットされます。